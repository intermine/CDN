(function(a){a(["module"],function(){var i,s,b;j.defer=d;j.resolve=t;j.reject=h;j.join=q;j.all=c;j.some=m;j.any=o;j.map=v;j.reduce=n;j.chain=r;j.isPromise=p;function j(y,A,z,x){return t(y).then(A,z,x)}function t(x){var z,y;if(x instanceof e){z=x}else{if(p(x)&&typeof x.valueOf==="function"){x=x.valueOf()}if(p(x)){y=d();x.then(y.resolve,y.reject,y.progress);z=y.promise}else{z=k(x)}}return z}function h(x){return j(x,function(y){return u(y)})}function e(x){this.then=x}e.prototype={always:function(x,y){return this.then(x,x,y)},otherwise:function(x){return this.then(b,x)}};function k(x){var y=new e(function(A){try{return t(A?A(x):x)}catch(z){return u(z)}});return y}function u(y){var x=new e(function(B,z){try{return z?t(z(y)):u(y)}catch(A){return u(A)}});return x}function d(){var G,H,A,C,z,y,E;H=new e(D);G={then:D,resolve:B,reject:F,progress:x,promise:H,resolver:{resolve:B,reject:F,progress:x}};A=[];C=[];z=function(M,K,L){var J,I;J=d();I=L?function(O){try{J.progress(L(O))}catch(N){J.progress(N)}}:J.progress;A.push(function(N){N.then(M,K).then(J.resolve,J.reject,I)});C.push(I);return J.promise};y=function(I){g(C,I);return I};E=function(I){I=t(I);z=I.then;E=t;y=f;g(A,I);C=A=b;return I};return G;function D(K,I,J){return z(K,I,J)}function B(I){return E(I)}function F(I){return E(u(I))}function x(I){return y(I)}}function p(x){return x&&typeof x.then==="function"}function m(z,y,B,x,A){l(2,arguments);return j(z,function(G){var M,L,N,E,O,K,H,C,J,I;J=G.length>>>0;M=Math.max(0,Math.min(y,J));N=[];L=(J-M)+1;E=[];O=d();if(!M){O.resolve(N)}else{C=O.progress;H=function(P){E.push(P);if(!--L){K=H=f;O.reject(E)}};K=function(P){N.push(P);if(!--M){K=H=f;O.resolve(N)}};for(I=0;I<J;++I){if(I in G){j(G[I],D,F,C)}}}return O.then(B,x,A);function F(P){H(P)}function D(P){K(P)}})}function o(y,B,x,A){function z(C){return B?B(C[0]):C[0]}return m(y,1,z,x,A)}function c(z,A,y,x){l(1,arguments);return v(z,w).then(A,y,x)}function q(){return v(arguments,w)}function v(y,x){return j(y,function(D){var A,C,F,G,H,B,E;F=C=D.length>>>0;A=[];E=d();if(!F){E.resolve(A)}else{H=E.reject;G=function z(J,I){j(J,x).then(function(K){A[I]=K;if(!--F){E.resolve(A)}},H)};for(B=0;B<C;B++){if(B in D){G(D[B],B)}else{--F}}}return E.promise})}function n(z,y){var x=s.call(arguments,1);return j(z,function(B){var A;A=B.length;x[0]=function(D,E,C){return j(D,function(F){return j(E,function(G){return y(F,G,C,A)})})};return i.apply(B,x)})}function r(x,A,z){var y=arguments.length>2;return j(x,function(B){return A.resolve(y?z:B)},A.reject,A.progress)}function g(x,A){var z,y=0;while(z=x[y++]){z(A)}}function l(A,z){var x,y=z.length;while(y>A){x=z[--y];if(x!=null&&typeof x!="function"){throw new Error("arg "+y+" must be a function")}}}function f(){}s=[].slice;i=[].reduce||function(C){var y,A,z,x,B;B=0;y=Object(this);x=y.length>>>0;A=arguments;if(A.length<=1){for(;;){if(B in y){z=y[B++];break}if(++B>=x){throw new TypeError()}}}else{z=A[1]}for(;B<x;++B){if(B in y){z=C(z,y[B],B,y)}}return z};function w(y){return y}return j})})(typeof define=="function"&&define.amd?define:function(b,a){typeof exports==="object"?(module.exports=a()):(this.when=a())});